generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model MeteorologicalStation {
  id             String                      @id @default(uuid())
  name           String                      @unique @db.VarChar(100)
  latitude       Decimal                     @db.Decimal(10, 8)
  longitude      Decimal                     @db.Decimal(11, 8)
  description    String?
  status         MeteorologicalStationStatus @default(ACTIVE)
  createdAt      DateTime                    @default(now()) @map("created_at")
  updatedAt      DateTime                    @updatedAt @map("updated_at")
  address        String?                     @db.VarChar(255)
  macAddress     String?                     @unique @map("mac_address") @db.VarChar(50)
  parameters     Parameter[]
  alerts         RegisteredAlerts[]
  sensorReadings SensorReading[]

  @@index([status])
  @@index([latitude, longitude])
  @@index([name])
  @@index([macAddress])
  @@map("meteorological_stations")
}

model SensorReading {
  id          String                   @id @default(uuid())
  stationId   String                   @map("station_id")
  timestamp   DateTime
  mongoId     String                   @unique @map("mongo_id")
  createdAt   DateTime                 @default(now()) @map("created_at")
  updatedAt   DateTime                 @updatedAt @map("updated_at")
  macEstacao  String?                  @map("mac_estacao")
  uuidEstacao String?                  @map("uuid_estacao")
  valor       Json                     @map("valor")
  alerts      RegisteredAlerts[]
  parameters  SensorReadingParameter[]
  station     MeteorologicalStation    @relation(fields: [stationId], references: [id], onDelete: Cascade)

  @@index([stationId])
  @@index([timestamp])
  @@index([stationId, timestamp])
  @@index([mongoId])
  @@map("sensor_readings")
}

model TipoParametro {
  id          String      @id @default(uuid())
  jsonId      String      @map("json_id")
  nome        String
  metrica     String
  polinomio   String?
  coeficiente Float[]
  leitura     Json
  parameters  Parameter[]

  @@map("tipo_parametro")
}

model Parameter {
  id              String                   @id @default(uuid())
  stationId       String                   @map("station_id")
  tipoParametroId String                   @map("tipo_parametro_id")
  tipoAlertaId    String?                  @map("tipo_alerta_id")
  station         MeteorologicalStation    @relation(fields: [stationId], references: [id], onDelete: Cascade)
  tipoAlerta      TipoAlerta?              @relation(fields: [tipoAlertaId], references: [id])
  tipoParametro   TipoParametro            @relation(fields: [tipoParametroId], references: [id], onDelete: Cascade)
  alerts          RegisteredAlerts[]       @relation("ParameterAlerts")
  readings        SensorReadingParameter[]

  @@unique([stationId, tipoParametroId])
  @@index([stationId])
  @@index([tipoParametroId])
  @@index([tipoAlertaId])
  @@map("parameter")
}

model TipoAlerta {
  id         String             @id @default(uuid())
  tipo       String
  publica    Boolean
  condicao   String
  criadoEm   DateTime           @default(now()) @map("criado_em")
  limite     Decimal
  nivel      String             @default("warning")
  duracaoMin Int?               @map("duracao_min")
  parameters Parameter[]
  alerts     RegisteredAlerts[]

  @@map("tipo_alerta")
}

model RegisteredAlerts {
  id           String                @id @default(uuid())
  stationId    String                @map("station_id")
  parameterId  String                @map("parameter_id")
  createdAt    DateTime              @default(now()) @map("created_at")
  data         DateTime              @default(now())
  medidasId    String?               @map("medidas_id")
  tipoAlertaId String                @map("tipo_alerta_id")
  medidas      SensorReading?        @relation(fields: [medidasId], references: [id])
  parameter    Parameter             @relation("ParameterAlerts", fields: [parameterId], references: [id], onDelete: Cascade)
  station      MeteorologicalStation @relation(fields: [stationId], references: [macAddress], onDelete: Cascade)
  tipoAlerta   TipoAlerta            @relation(fields: [tipoAlertaId], references: [id], onDelete: Cascade)

  @@index([stationId])
  @@index([parameterId])
  @@index([tipoAlertaId])
  @@index([medidasId])
  @@map("registered_alerts")
}

model MigrationState {
  id                String   @id @default(uuid())
  name              String   @unique
  lastSyncTimestamp Int      @map("last_sync_timestamp")
  totalMigrated     Int      @default(0) @map("total_migrated")
  lastRunAt         DateTime @default(now()) @map("last_run_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("migration_states")
}

model SensorReadingParameter {
  sensorReadingId String
  parameterId     String
  parameter       Parameter     @relation(fields: [parameterId], references: [id], onDelete: Cascade)
  sensorReading   SensorReading @relation(fields: [sensorReadingId], references: [id], onDelete: Cascade)

  @@id([sensorReadingId, parameterId])
  @@map("sensor_reading_parameters")
}

enum MeteorologicalStationStatus {
  ACTIVE
  INACTIVE
}
